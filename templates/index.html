{% extends 'layout.html' %}
{% block title %}Home - Cafe Finder{% endblock %}

{% block content %}
{% if session.get('username') %}
  {% include 'profile_card.html' with context %}
  <div class="mb-2">
    <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-primary btn-sm">Edit Profil</a>
  </div>
{% endif %}

<div class="row mb-3">
  <div class="col-12">
    <div class="card shadow-sm p-4 mb-3" style="background:#fff8ee;border-radius:16px;">
      <form method="GET" action="{{ url_for('home') }}">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label" for="search">Cari café/menu/kategori</label>
            <input class="form-control" type="search" id="search" placeholder="Cari café, menu, kategori..." aria-label="Search" name="q" value="{{ q or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label" for="lokasi">Lokasi</label>
            <select class="form-select" name="lokasi" id="lokasi">
              <option value="">Semua Lokasi</option>
              <option value="Surabaya Barat" {% if lokasi=='Surabaya Barat' %}selected{% endif %}>Surabaya Barat</option>
              <option value="Surabaya Timur" {% if lokasi=='Surabaya Timur' %}selected{% endif %}>Surabaya Timur</option>
              <option value="Surabaya Tengah" {% if lokasi=='Surabaya Tengah' %}selected{% endif %}>Surabaya Tengah</option>
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label">Kategori</label>
            <div class="row row-cols-2 row-cols-md-3 g-1">
              {% set all_kategori = [] %}
              {% for cafe in cafes %}
                {% for k in cafe.kategori %}
                  {% if k not in all_kategori %}
                    {% set _ = all_kategori.append(k) %}
                  {% endif %}
                {% endfor %}
              {% endfor %}
              {% for k in all_kategori|sort %}
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="kategori" value="{{ k }}" id="kat-{{ k }}"
                      {% if kategori and k.lower() in kategori.lower().split(',') %}checked{% endif %}>
                    <label class="form-check-label" for="kat-{{ k }}">{{ k }}</label>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-8"></div>
          <div class="col-md-2 text-end">
            <a class="btn btn-outline-secondary w-100" href="{{ url_for('home') }}">Reset</a>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Cari</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="cafes">
  {% for cafe in cafes %}
  <div class="cafe-card">
    {% if cafe.photo %}
      <img src="{{ url_for('static', filename='uploads/' + cafe.photo) }}" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
    {% else %}
      <img src="https://via.placeholder.com/400x200?text=No+Image" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
    {% endif %}
    <h3>{{ cafe.nama }}</h3>
    <div class="text-muted mb-1">{{ cafe.lokasi }}</div>
    {% if cafe.kategori %}
      <div class="mb-1"><small>{{ cafe.kategori|join(', ') }}</small></div>
    {% endif %}
    {% if cafe.menu %}
      <ul class="small mb-2">
        {% for m in cafe.menu[:2] %}
          <li>{{ m.nama }} — Rp{{ '{:,.0f}'.format(m.harga|int) }}</li>
        {% endfor %}
        {% if cafe.menu|length > 2 %}
          <li class="text-muted">...dan {{ cafe.menu|length - 2 }} menu lainnya</li>
        {% endif %}
      </ul>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center">
      <a href="{{ url_for('cafe_detail', cafe_id=cafe.id) }}" class="btn btn-outline-primary btn-sm">Detail</a>
      <form action="{{ url_for('toggle_like', cafe_id=cafe.id) }}" method="post">
        <button class="btn btn-sm {% if session['username'] in cafe.likes %}btn-danger{% else %}btn-outline-danger{% endif %}">
          <span style="font-size:1.2em;">❤</span> {{ cafe.likes|length }}
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}

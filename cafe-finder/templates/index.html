{% extends 'layout.html' %}
{% block title %}Home - Cafe Finder{% endblock %}
{% block content %}

<div class="row mb-3">
  <div class="col-md-8">
    <form class="d-flex" method="GET" action="{{ url_for('home') }}">
      <input class="form-control me-2" type="search" placeholder="Cari café, menu, kategori..." aria-label="Search" name="q" value="{{ q or '' }}">
      <select class="form-select me-2" name="lokasi" style="max-width: 180px;">
        <option value="">Semua Lokasi</option>
        <option value="Surabaya Barat" {% if lokasi=='Surabaya Barat' %}selected{% endif %}>Surabaya Barat</option>
        <option value="Surabaya Timur" {% if lokasi=='Surabaya Timur' %}selected{% endif %}>Surabaya Timur</option>
        <option value="Surabaya Tengah" {% if lokasi=='Surabaya Tengah' %}selected{% endif %}>Surabaya Tengah</option>
      </select>
      <!-- Filter kategori dengan checkbox -->
      <div class="d-flex align-items-center" style="gap:8px;max-width:400px;flex-wrap:wrap;">
        {% set all_kategori = [] %}
        {% for cafe in cafes %}
          {% for k in cafe.kategori %}
            {% if k not in all_kategori %}
              {% set _ = all_kategori.append(k) %}
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% for k in all_kategori|sort %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="kategori" value="{{ k }}" id="kat-{{ k }}"
              {% if kategori and k.lower() in kategori.lower().split(',') %}checked{% endif %}>
            <label class="form-check-label" for="kat-{{ k }}">{{ k }}</label>
          </div>
        {% endfor %}
      </div>
      <button class="btn btn-primary" type="submit">Cari</button>
    </form>
  </div>
  <div class="col-md-4 text-end">
    <a class="btn btn-outline-secondary" href="{{ url_for('home') }}">Reset</a>
  </div>
</div>

<div class="cafes">
  {% for cafe in cafes %}
  <div class="cafe-card">
    {% if cafe.photo %}
      <img src="{{ url_for('static', filename='uploads/' + cafe.photo) }}" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
    {% else %}
      <img src="https://via.placeholder.com/400x200?text=No+Image" style="width:100%;height:180px;object-fit:cover;border-radius:6px;">
    {% endif %}
    <h3>{{ cafe.nama }}</h3>
    <div class="text-muted mb-1">{{ cafe.lokasi }}</div>
    {% if cafe.kategori %}
      <div class="mb-1"><small>{{ cafe.kategori|join(', ') }}</small></div>
    {% endif %}
    {% if cafe.menu %}
      <ul class="small mb-2">
        {% for m in cafe.menu[:2] %}
          <li>{{ m.nama }} — Rp{{ '{:,.0f}'.format(m.harga) }}</li>
        {% endfor %}
        {% if cafe.menu|length > 2 %}
          <li class="text-muted">...dan {{ cafe.menu|length - 2 }} menu lainnya</li>
        {% endif %}
      </ul>
    {% endif %}
    <div class="d-flex justify-content-between">
      <a href="{{ url_for('cafe_detail', cafe_id=cafe.id) }}" class="btn btn-outline-primary btn-sm">Detail</a>
      <form action="{{ url_for('toggle_favorite', cafe_id=cafe.id) }}" method="post">
        <button class="btn btn-sm {% if cafe.id in favorites %}btn-danger{% else %}btn-outline-danger{% endif %}">
          {% if cafe.id in favorites %}Unfav{% else %}Fav{% endif %}
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}
